<!doctype html>
<html lang="en">
<head>
Â Â <meta charset="utf-8" />
Â Â <title>AMI â€” Upload Report</title>
Â Â <meta name="viewport" content="width=device-width,initial-scale=1" />
Â Â <link rel="stylesheet" href="/styles.css" />
</head>

<body>
Â Â <div class="app">
Â Â Â Â 
Â Â Â Â <!-- Sidebar -->
Â Â Â Â <aside class="sidebar">
Â Â Â Â Â Â <div class="brand">
Â Â Â Â Â Â Â Â <img src="/logo.png" alt="AMI logo" style="width:48px;height:auto;">
Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â <h3>AMI Health</h3>
Â Â Â Â Â Â Â Â Â Â <p>Upload Reports</p>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <nav class="nav">
Â Â Â Â Â Â Â Â <a href="/dashboard.html">Dashboard</a>
Â Â Â Â Â Â Â Â <a class="active" href="/upload.html">Upload Report</a>
Â Â Â Â Â Â </nav>

Â Â Â Â Â Â <div style="margin-top:auto">
Â Â Â Â Â Â Â Â <div id="userEmailSmall" style="font-weight:700"></div>
Â Â Â Â Â Â Â Â <div style="height:10px"></div>
Â Â Â Â Â Â Â Â <button id="logoutBtn" class="btn">Logout</button>
Â Â Â Â Â Â </div>
Â Â Â Â </aside>

Â Â Â Â <!-- Main content -->
Â Â Â Â <main class="main">
Â Â Â Â Â Â <div style="display:flex;justify-content:space-between;align-items:center">
Â Â Â Â Â Â Â Â <div style="font-size:20px;font-weight:800;color:var(--accent)">
Â Â Â Â Â Â Â Â Â Â Upload Scan or Lab Report
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="card" style="max-width:880px">
Â Â Â Â Â Â Â Â <p style="color:var(--muted)">
Â Â Â Â Â Â Â Â Â Â Select PDF or image files (jpg, png). Files are uploaded to Supabase Storage (bucket:
Â Â Â Â Â Â Â Â Â Â <code>reports</code>) and queued for processing.
Â Â Â Â Â Â Â Â </p>

Â Â Â Â Â Â Â Â <input id="fileInput" type="file" accept="image/*,application/pdf" multiple />

Â Â Â Â Â Â Â Â <div style="display:flex;gap:10px;margin-top:10px">
Â Â Â Â Â Â Â Â Â Â <input id="title" type="text" placeholder="Report title (optional)"
Â Â Â Â Â Â Â Â Â Â Â Â style="flex:1;padding:10px;border-radius:8px;border:1px solid #eee" />
Â Â Â Â Â Â Â Â Â Â <button id="uploadBtn" class="btn">Upload & Queue</button>
Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â <div id="progressArea" style="margin-top:12px"></div>
Â Â Â Â Â Â Â Â <ul id="filesList" style="margin-top:10px"></ul>
Â Â Â Â Â Â </div>
Â Â Â Â </main>
Â Â </div>

<!-- Script -->
<script type="module">
Â Â const SUPA_URL = "https://tbyttsfztuudyqbrkonm.supabase.co";
Â Â const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRieXR0c2Z6dHV1ZHlxYnJrb25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzA1MzgsImV4cCI6MjA3OTAwNjUzOH0.7T0S4_kkoWosdbmjlwtfSYzBcyipcPg1Fm8kIMa43uo";

Â Â import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
Â Â const supabase = createClient(SUPA_URL, SUPA_ANON);

Â Â // Auth guard
Â Â const loggedInUser = localStorage.getItem("user_email");
Â Â if (!loggedInUser) window.location.href = "/login.html";
Â Â document.getElementById("userEmailSmall").innerText = loggedInUser;

Â Â document.getElementById("logoutBtn").onclick = () => {
Â Â Â Â localStorage.removeItem("user_email");
Â Â Â Â window.location.href = "/login.html";
Â Â };

Â Â const fileInput = document.getElementById("fileInput");
Â Â const uploadBtn = document.getElementById("uploadBtn");
Â Â const progressArea = document.getElementById("progressArea");
Â Â const filesList = document.getElementById("filesList");

Â Â async function uploadFile(file) {
Â Â Â Â const clean = file.name.replace(/\s+/g, "_");
Â Â Â Â const filename = `${Date.now()}_${clean}`;

Â Â Â Â const { data, error } = await supabase.storage
Â Â Â Â Â Â .from("reports")
Â Â Â Â Â Â .upload(filename, file);

Â Â Â Â if (error) throw error;
Â Â Â Â return data.path;
Â Â }

Â Â uploadBtn.onclick = async () => {
Â Â Â Â const files = [...(fileInput.files || [])];
Â Â Â Â if (!files.length) {
Â Â Â Â Â Â progressArea.innerText = "Please select at least one file.";
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â uploadBtn.disabled = true;
Â Â Â Â progressArea.innerText = "Uploading...";
Â Â Â Â filesList.innerHTML = "";

Â Â Â Â try {
Â Â Â Â Â Â const uploaded = [];

Â Â Â Â Â Â for (const f of files) {
Â Â Â Â Â Â Â Â const li = document.createElement("li");
Â Â Â Â Â Â Â Â li.innerText = `Uploading ${f.name}...`;
Â Â Â Â Â Â Â Â filesList.appendChild(li);

Â Â Â Â Â Â Â Â const path = await uploadFile(f);
Â Â Â Â Â Â Â Â uploaded.push(path);
Â Â Â Â Â Â Â Â li.innerText = `Uploaded: ${path}`;
Â Â Â Â Â Â }

Â Â Â Â Â Â // ðŸ”¥ CALL YOUR BACKEND
Â Â Â Â Â Â const resp = await fetch("/api/create-report", {
Â Â Â Â Â Â Â Â method: "POST",
Â Â Â Â Â Â Â Â headers: { "Content-Type": "application/json" },
Â Â Â Â Â Â Â Â body: JSON.stringify({
Â Â Â Â Â Â Â Â Â Â email: loggedInUser,
Â Â Â Â Â Â Â Â Â Â title: document.getElementById("title").value || null,
Â Â Â Â Â Â Â Â Â Â files: uploaded
Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â });

Â Â Â Â Â Â const result = await resp.json();
Â Â Â Â Â Â if (!resp.ok) throw new Error(result.error);

Â Â Â Â Â Â progressArea.innerText = "Uploaded & queued. Report ID: " + result.id;

Â Â Â Â } catch (err) {
Â Â Â Â Â Â progressArea.innerText = "Error: " + err.message;
Â Â Â Â Â Â console.error(err);

Â Â Â Â } finally {
Â Â Â Â Â Â uploadBtn.disabled = false;
Â Â Â Â }
Â Â };
</script>

</body>
</html>
