<!doctype html>
<html lang="en">
<head>
Â Â <meta charset="utf-8" />
Â Â <title>AMI â€” Upload Report</title>
Â Â <meta name="viewport" content="width=device-width,initial-scale=1" />
Â Â <link rel="stylesheet" href="/styles.css" />
Â Â <style>
Â Â Â Â .upload-card {
Â Â Â Â Â Â background: white;
Â Â Â Â Â Â padding: 25px;
Â Â Â Â Â Â border-radius: 16px;
Â Â Â Â Â Â box-shadow: 0 4px 20px rgba(0,0,0,0.05);
Â Â Â Â Â Â max-width: 880px;
Â Â Â Â Â Â margin-top: 20px;
Â Â Â Â }

Â Â Â Â input[type="file"] {
Â Â Â Â Â Â background: #f7f7f7;
Â Â Â Â Â Â padding: 14px;
Â Â Â Â Â Â border-radius: 10px;
Â Â Â Â Â Â border: 1px solid #ddd;
Â Â Â Â Â Â width: 100%;
Â Â Â Â Â Â cursor: pointer;
Â Â Â Â }

Â Â Â Â #progressArea {
Â Â Â Â Â Â margin-top: 10px;
Â Â Â Â Â Â font-weight: 600;
Â Â Â Â Â Â color: var(--accent);
Â Â Â Â }

Â Â Â Â #filesList li {
Â Â Â Â Â Â padding: 6px 0;
Â Â Â Â Â Â border-bottom: 1px solid #eee;
Â Â Â Â }
Â Â </style>
</head>

<body>
Â Â <div class="app">

Â Â Â Â <!-- Sidebar -->
Â Â Â Â <aside class="sidebar">
Â Â Â Â Â Â <div class="brand">
Â Â Â Â Â Â Â Â <img src="/logo.png" alt="AMI logo" style="width:48px;height:auto;">
Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â <h3>AMI Health</h3>
Â Â Â Â Â Â Â Â Â Â <p>Upload reports</p>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <nav class="nav">
Â Â Â Â Â Â Â Â <a href="/dashboard.html">Dashboard</a>
Â Â Â Â Â Â Â Â <a href="/upload.html" class="active">Upload Report</a>
Â Â Â Â Â Â </nav>

Â Â Â Â Â Â <div style="margin-top:auto">
Â Â Â Â Â Â Â Â <div id="userEmailSmall" style="font-weight:700"></div>
Â Â Â Â Â Â Â Â <div style="height:10px"></div>
Â Â Â Â Â Â Â Â <button id="logoutBtn" class="btn">Logout</button>
Â Â Â Â Â Â </div>
Â Â Â Â </aside>

Â Â Â Â <!-- Main Content -->
Â Â Â Â <main class="main">
Â Â Â Â Â Â <div style="font-weight:800;font-size:22px;color:var(--accent);">
Â Â Â Â Â Â Â Â Upload Scan or Lab Report
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="upload-card">
Â Â Â Â Â Â Â Â <p style="color:var(--muted)">
Â Â Â Â Â Â Â Â Â Â Select PDF or image files (jpg, png). They will upload to Supabase Storage
Â Â Â Â Â Â Â Â Â Â (bucket: <code>reports</code>) and then be queued for AI analysis.
Â Â Â Â Â Â Â Â </p>

Â Â Â Â Â Â Â Â <input id="fileInput" type="file" accept="image/*,application/pdf" multiple>

Â Â Â Â Â Â Â Â <div style="display:flex;gap:10px;margin-top:12px;">
Â Â Â Â Â Â Â Â Â Â <input id="title" type="text" placeholder="Report title (optional)"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â style="flex:1;padding:12px;border-radius:8px;border:1px solid #ddd;">
Â Â Â Â Â Â Â Â Â Â <button id="uploadBtn" class="btn">Upload & Queue</button>
Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â <div id="progressArea"></div>
Â Â Â Â Â Â Â Â <ul id="filesList"></ul>
Â Â Â Â Â Â </div>
Â Â Â Â </main>

Â Â </div>

<script type="module">
Â Â const SUPA_URL = "https://tbyttsfztuudyqbrkonm.supabase.co";
Â Â const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRieXR0c2Z6dHV1ZHlxYnJrb25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzA1MzgsImV4cCI6MjA3OTAwNjUzOH0.7T0S4_kkoWosdbmjlwtfSYzBcyipcPg1Fm8kIMa43uo";

Â Â import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
Â Â const supabase = createClient(SUPA_URL, SUPA_ANON);

Â Â // Auth guard
Â Â const user = localStorage.getItem("user_email");
Â Â if (!user) window.location.href = "/login.html";
Â Â document.getElementById("userEmailSmall").innerText = user;

Â Â document.getElementById("logoutBtn").onclick = () => {
Â Â Â Â localStorage.removeItem("user_email");
Â Â Â Â window.location.href = "/login.html";
Â Â };

Â Â const fileInput = document.getElementById("fileInput");
Â Â const uploadBtn = document.getElementById("uploadBtn");
Â Â const progressArea = document.getElementById("progressArea");
Â Â const filesList = document.getElementById("filesList");

Â Â async function uploadFile(file) {
Â Â Â Â const clean = file.name.replace(/\s+/g, "_");
Â Â Â Â const filename = `${Date.now()}_${clean}`;

Â Â Â Â const { data, error } = await supabase.storage
Â Â Â Â Â Â .from("reports")
Â Â Â Â Â Â .upload(filename, file, { cacheControl: "3600", upsert: false });

Â Â Â Â if (error) throw error;
Â Â Â Â return data.path;
Â Â }

Â Â uploadBtn.addEventListener("click", async () => {
Â Â Â Â const files = Array.from(fileInput.files || []);
Â Â Â Â if (!files.length) {
Â Â Â Â Â Â progressArea.innerText = "Please select at least one file.";
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â uploadBtn.disabled = true;
Â Â Â Â progressArea.innerText = "Uploading...";
Â Â Â Â filesList.innerHTML = "";

Â Â Â Â try {
Â Â Â Â Â Â const uploadedPaths = [];

Â Â Â Â Â Â for (const file of files) {
Â Â Â Â Â Â Â Â const li = document.createElement("li");
Â Â Â Â Â Â Â Â li.innerText = `Uploading ${file.name}...`;
Â Â Â Â Â Â Â Â filesList.appendChild(li);

Â Â Â Â Â Â Â Â const path = await uploadFile(file);
Â Â Â Â Â Â Â Â uploadedPaths.push(path);

Â Â Â Â Â Â Â Â li.innerText = `Uploaded: ${path}`;
Â Â Â Â Â Â }

Â Â Â Â Â Â // Send to backend API (correct URL)
Â Â Â Â Â Â console.log("ðŸ“¡ Sending POST to /api/create-report");

const resp = await fetch("/api/create-report", {
Â Â Â Â Â Â Â Â method: "POST",
Â Â Â Â Â Â Â Â headers: { "Content-Type": "application/json" },
Â Â Â Â Â Â Â Â body: JSON.stringify({
Â Â Â Â Â Â Â Â Â Â email: user,
Â Â Â Â Â Â Â Â Â Â title: document.getElementById("title").value || null,
Â Â Â Â Â Â Â Â Â Â files: uploadedPaths
Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â });

Â Â Â Â Â Â const json = await resp.json();

Â Â Â Â Â Â if (!resp.ok) throw new Error(json.error || "Failed to create report record");

Â Â Â Â Â Â progressArea.innerText =
Â Â Â Â Â Â Â Â "Uploaded & queued. Report ID: " + (json.id || "N/A");

Â Â Â Â } catch (err) {
Â Â Â Â Â Â console.error(err);
Â Â Â Â Â Â progressArea.innerText = "Error: " + (err.message || err);
Â Â Â Â } finally {
Â Â Â Â Â Â uploadBtn.disabled = false;
Â Â Â Â }
Â Â });
</script>

</body>
</html>
