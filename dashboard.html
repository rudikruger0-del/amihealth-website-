<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AMI Health — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* small dashboard-specific styles (keeps your existing look) */
    .center { max-width:1100px; margin:24px auto; padding:12px; }
    .card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:16px; }
    #upload-area { border:2px dashed #d0eaf2; padding:18px; text-align:center; }
    #report { white-space:pre-wrap; font-family:monospace; background:#f7f9fb; padding:12px; border-radius:8px; }
    .grid { display:grid; grid-template-columns:1fr 380px; gap:18px; }
    .btn { background:#00bcd4; color:#000; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .muted { color:#666; font-size:0.95rem; }
    progress { width:100%; }
  </style>
</head>
<body>
  <div class="topbar" style="background:#002b47;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;">
    <div id="welcome">Loading...</div>
    <div>
      <button id="logout-btn" class="btn">Logout</button>
    </div>
  </div>

  <div class="center">
    <h1>AMI — AI Lab Tools</h1>

    <div class="grid">
      <div>
        <div class="card">
          <h3>Upload CBC / Blood Test (image or PDF)</h3>
          <div id="upload-area">
            <input id="file-input" type="file" accept="image/*,application/pdf" />
            <p class="muted">Supported: JPG/PNG/PDF. Reports are processed in your browser.</p>
            <div style="margin-top:10px;">
              <button id="process-btn" class="btn">Process file</button>
            </div>
            <div style="margin-top:12px;"><progress id="ocr-progress" value="0" max="100" style="display:none;"></progress></div>
            <div id="status" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>

        <div class="card">
          <h3>AI Report (Preview)</h3>
          <div id="report">No report yet. Upload a lab image or PDF and click Process.</div>
          <div style="margin-top:12px;">
            <button id="save-btn" class="btn" disabled>Save report to my account</button>
            <span id="save-msg" class="muted" style="margin-left:12px;"></span>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Parsed Markers</h3>
          <div id="parsed-json" style="font-family:monospace; white-space:pre-wrap;">{ }</div>
        </div>

        <div class="card">
          <h3>Notes & Actions</h3>
          <div id="notes" class="muted">After saving, reports will appear in your Supabase `reports` table. Use this area to add clinical notes later.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tesseract (browser OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <script type="module">
    import { supabase } from "./lib/supabaseClient.js";

    // --- helper: simple OCR for PDFs and images
    async function fileToImageData(file) {
      // If PDF, convert first page to image (simple approach using blob URL; for multi-page PDFs a more advanced lib is required)
      if (file.type === "application/pdf") {
        // for PDF in browser we render using <embed> then draw to canvas — but to keep this lightweight, try Tesseract on pdf blob directly
        // Tesseract can accept PDF in many cases; fallback to file blob URL
      }
      return URL.createObjectURL(file);
    }

    // --- parsing rules (simple regexes)
    function parseMarkers(text) {
      const tx = text.replace(/\r/g, '\n');
      const get = (re) => {
        const m = tx.match(re);
        return m ? parseFloat(m[1].replace(',', '.')) : null;
      };

      const parsed = {
        hemoglobin: get(/hemoglobin[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i) || get(/hb[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        rbc: get(/(?:rbc|red blood cell)[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        hct: get(/hct[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        mcv: get(/mcv[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        mch: get(/mch[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        mchc: get(/mchc[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        wbc: get(/white cell count[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i) || get(/wbc[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        neutrophils_pct: get(/neu%[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i) || get(/neutrophil[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)\s*%/i),
        lymphocytes_pct: get(/lym%[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i) || get(/lymphocyte[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)\s*%/i),
        platelets: get(/pl(?:t|atelet)[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i) || get(/\bplt[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i),
        esr: get(/esr[^\d\-]*?([0-9]+(?:[.,][0-9]+)?)/i)
      };

      return parsed;
    }

    // --- simple clinical rules (conservative) — for clinician review only
    function interpret(parsed) {
      const flags = [];
      const recs = [];

      const Hb = parsed.hemoglobin;
      if (Hb !== null) {
        if (Hb < 8) { flags.push({ marker:'Hemoglobin', severity:'critical', note:'Severe anemia — urgent review' }); }
        else if (Hb < 11) { flags.push({ marker:'Hemoglobin', severity:'mild', note:'Low Hb — consider iron studies if symptomatic' }); }
      }

      const WBC = parsed.wbc;
      if (WBC !== null) {
        if (WBC < 3.5) flags.push({ marker:'WBC', severity:'moderate', note:'Leukopenia — correlate clinically' });
        if (WBC > 11) flags.push({ marker:'WBC', severity:'moderate', note:'Leukocytosis — possible infection or inflammation' });
      }

      const PLT = parsed.platelets;
      if (PLT !== null) {
        if (PLT < 50) flags.push({ marker:'Platelets', severity:'critical', note:'Severe thrombocytopenia — urgent review' });
        else if (PLT < 150) flags.push({ marker:'Platelets', severity:'mild', note:'Low platelets — monitor and correlate' });
        else if (PLT > 450) flags.push({ marker:'Platelets', severity:'moderate', note:'Thrombocytosis — consider further workup' });
      }

      // Basophils, neutrophils etc are informational
      if (flags.length === 0) recs.push('No immediate critical flags identified; interpret in clinical context.');

      return { flags, recs };
    }

    // --- UI wiring
    const fileInput = document.getElementById('file-input');
    const processBtn = document.getElementById('process-btn');
    const statusEl = document.getElementById('status');
    const progressBar = document.getElementById('ocr-progress');
    const reportEl = document.getElementById('report');
    const parsedJsonEl = document.getElementById('parsed-json');
    const saveBtn = document.getElementById('save-btn');
    const saveMsg = document.getElementById('save-msg');

    let lastOCRText = null;
    let lastParsed = null;
    let lastSummary = null;
    let lastFile = null;
    let lastStoragePath = null;

    processBtn.addEventListener('click', async () => {
      saveMsg.innerText = '';
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please choose a file first');
        return;
      }
      const file = fileInput.files[0];
      lastFile = file;
      statusEl.innerText = 'Preparing file...';
      progressBar.style.display = 'none';
      // Convert to object URL for Tesseract
      const blobUrl = URL.createObjectURL(file);

      statusEl.innerText = 'Running OCR (this can take 10–30s depending on file size)...';
      progressBar.style.display = 'block';
      progressBar.value = 0;

      // Tesseract.js recognizes PDF and images; use worker to get progress
      const worker = Tesseract.createWorker({
        logger: m => {
          if (m.status === 'recognizing text' || m.status === 'recognizing') {
            const p = Math.min(100, Math.round((m.progress||0)*100));
            progressBar.value = p;
          }
          // show status messages small
          statusEl.innerText = m.status + (m.progress ? ' ' + Math.round(m.progress*100) + '%' : '');
        }
      });

      try {
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');

        // For PDFs, tesseract can accept blob URL; here we pass the file blob directly
        const { data: { text } } = await worker.recognize(file);
        lastOCRText = text;
        await worker.terminate();

        statusEl.innerText = 'Parsing values...';
        const parsed = parseMarkers(text);
        lastParsed = parsed;

        const interp = interpret(parsed);
        lastSummary = {
          flags: interp.flags,
          recs: interp.recs,
          quick: `Hemoglobin: ${parsed.hemoglobin||'N/A'} | WBC: ${parsed.wbc||'N/A'} | Platelets: ${parsed.platelets||'N/A'}`
        };

        // Update UI
        parsedJsonEl.innerText = JSON.stringify(parsed, null, 2);
        reportEl.innerText = `--- AMI Health — CBC AI Preview ---\n\nQuick: ${lastSummary.quick}\n\nFlags:\n${interp.flags.length? JSON.stringify(interp.flags,null,2):'None'}\n\nRecommendations:\n${interp.recs.join('\\n')}\n\n--- OCR RAW TEXT (first 800 chars) ---\n${text.slice(0,800)}\n\n(Report for clinician review only — not a diagnosis.)`;

        statusEl.innerText = 'OCR done. You can save this report to your account.';
        saveBtn.disabled = false;
      } catch (err) {
        console.error(err);
        statusEl.innerText = 'OCR failed: ' + (err.message||err);
        await worker.terminate();
      } finally {
        progressBar.style.display = 'none';
      }
    });

    // --- Save to Supabase: upload file + insert report row
    saveBtn.addEventListener('click', async () => {
      saveMsg.innerText = '';
      saveBtn.disabled = true;
      try {
        // ensure logged in
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          alert('Please sign in again');
          window.location.href = 'login.html';
          return;
        }

        let storagePath = null;
        if (lastFile) {
          const filename = `${Date.now()}_${lastFile.name.replace(/\s+/g,'_')}`;
          const bucket = 'reports';
          // upload
          const { data: uploadData, error: upErr } = await supabase.storage.from(bucket).upload(`${user.id}/${filename}`, lastFile);
          if (upErr) {
            console.warn('Upload error', upErr);
            // continue — we can still save the report without storage
          } else {
            storagePath = uploadData.path;
            lastStoragePath = storagePath;
          }
        }

        // insert row
        const insertPayload = {
          user_id: (await supabase.auth.getUser()).data.user.id,
          filename: lastFile ? lastFile.name : null,
          storage_path: storagePath,
          raw_text: lastOCRText,
          parsed: lastParsed,
          summary: JSON.stringify(lastSummary)
        };

        const { data, error } = await supabase.from('reports').insert([insertPayload]);
        if (error) throw error;

        saveMsg.innerText = 'Saved ✓';
      } catch (err) {
        console.error(err);
        saveMsg.innerText = 'Save failed: ' + (err.message || err);
      } finally {
        saveBtn.disabled = false;
      }
    });

    // --- Logout + welcome
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    });

    // Protect page: require login
    (async function protect() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return window.location.href = 'login.html';
      document.getElementById('welcome').innerText = 'Welcome, ' + user.email;
    })();
  </script>
</body>
</html>
