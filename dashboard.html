<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AMI — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0;padding:18px}
    header{background:#063c6b;color:#fff;padding:14px;border-radius:8px;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center}
    .wrap{max-width:1000px;margin:0 auto}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 8px 30px rgba(12,30,60,0.06);margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .status-queued{color:#ff9800}
    .status-processing{color:#007aff}
    .status-done{color:#009688}
    .btn{background:#007aff;color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .small{font-size:13px;color:#666}
    .file-thumb{max-width:120px;border-radius:6px;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div><strong>AMI Health</strong> — Dashboard</div>
      <div>
        <button id="uploadBtn" class="btn">Upload New</button>
        <button id="logoutBtn" class="btn" style="background:#ff3b30;margin-left:8px">Logout</button>
      </div>
    </header>

    <div id="content"></div>
  </div>

  <script type="module">
    // ---------- CONFIG ----------
    const SUPA_URL = "https://tbyttsfztuudyqbrkonm.supabase.co";
    const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRieXR0c2Z6dHV1ZHlxYnJrb25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzA1MzgsImV4cCI6MjA3OTAwNjUzOH0.7T0S4_kkoWosdbmjlwtfSYzBcyipcPg1Fm8kIMa43uo";
    // ----------------------------
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(SUPA_URL, SUPA_ANON);

    const content = document.getElementById("content");
    const uploadBtn = document.getElementById("uploadBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // basic auth guard (we used localStorage in your login)
    const userEmail = localStorage.getItem("user_email");
    if (!userEmail) {
      window.location.href = "login.html";
    }

    uploadBtn.addEventListener("click", () => {
      window.location.href = "upload.html";
    });

    logoutBtn.addEventListener("click", async () => {
      localStorage.removeItem("user_email");
      window.location.href = "login.html";
    });

    // Fetch reports for the user
    async function loadReports() {
      content.innerHTML = "<div class='card small'>Loading reports...</div>";

      try {
        // Use the REST endpoint via anon key to query the public.reports table.
        // We assume create-report stored owner_user_email in metadata or column.
        // Query reports where owner_user_email = userEmail (or adjust if owner_user_id used)
        const res = await fetch(`${SUPA_URL}/rest/v1/reports?owner_user_email=eq.${encodeURIComponent(userEmail)}&order=created_at.desc`, {
          headers: {
            "apikey": SUPA_ANON,
            "Authorization": `Bearer ${SUPA_ANON}`,
            "Accept": "application/json"
          }
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err || "Failed to fetch reports");
        }

        const rows = await res.json();
        if (!rows.length) {
          content.innerHTML = `<div class="card small">No reports yet. <a href="upload.html">Upload one</a>.</div>`;
          return;
        }

        let html = `<div class="card"><table><thead><tr><th>Created</th><th>Title</th><th>Files</th><th>Status</th><th>Result</th><th></th></tr></thead><tbody>`;
        for (const r of rows) {
          const created = new Date(r.created_at).toLocaleString();
          const title = r.title || "(no title)";
          const status = r.status || "queued";
          const statusClass = status === "queued" ? "status-queued" : status === "processing" ? "status-processing" : "status-done";

          // files are stored as array of storage paths
          let filesHtml = "";
          if (r.files && Array.isArray(r.files)) {
            for (const p of r.files) {
              // show thumbnail if image
              const ext = p.split('.').pop().toLowerCase();
              const publicUrl = `${SUPA_URL}/storage/v1/object/public/reports/${encodeURIComponent(p)}`;
              if (["jpg","jpeg","png","gif","webp"].includes(ext)) {
                filesHtml += `<a target="_blank" href="${publicUrl}"><img class="file-thumb" src="${publicUrl}" alt=""></a>`;
              } else {
                filesHtml += `<div><a target="_blank" href="${publicUrl}">${p.split('/').pop()}</a></div>`;
              }
            }
          }

          let resultSummary = "(none)";
          if (r.result) {
            try {
              const resObj = typeof r.result === "string" ? JSON.parse(r.result) : r.result;
              // Show a short summary if present
              if (resObj.summary) resultSummary = resObj.summary;
              else resultSummary = JSON.stringify(resObj).slice(0,120) + (JSON.stringify(resObj).length>120?"...":"");
            } catch(e) {
              resultSummary = String(r.result).slice(0,120);
            }
          }

          html += `<tr>
            <td style="width:150px">${created}</td>
            <td>${title}</td>
            <td style="width:200px">${filesHtml}</td>
            <td class="${statusClass}">${status}</td>
            <td style="max-width:260px">${resultSummary}</td>
            <td><button class="btn" onclick="viewReport('${r.id}')">Open</button></td>
          </tr>`;
        }
        html += `</tbody></table></div>`;
        content.innerHTML = html;

      } catch (err) {
        console.error(err);
        content.innerHTML = `<div class="card small">Error loading reports: ${err.message || err}</div>`;
      }
    }

    // open detailed view in new window (simple)
    window.viewReport = function(id) {
      window.location.href = `report.html?id=${encodeURIComponent(id)}`; // you can create a report.html later
    };

    // initial load
    loadReports();

    // optional: poll every 8s to update statuses
    setInterval(loadReports, 8000);
  </script>
</body>
</html>
